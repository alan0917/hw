<!DOCTYPE html>

<html>

<head>
<style>
	#info {
  position: absolute;
  top: 2%;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

body {
  overflow: hidden;
}



</style>
</head>

<body> 
	<div id="info">
  <br/>
  <button id="shoot" style="width:15%">start</button>
  <br/>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r78/three.min.js"></script>
<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>

<script>
	var scene, renderer, camera;
var controls;
var keyboard = new KeyboardState();
var clock = new THREE.Clock();
var clock2 = new THREE.Clock();
var turn = false, turn2 = true ;
var period = 1;
var long = 0 , v0 = 0;
var pos, vel, force;
var ball;
var v0;
var upangle;
gcontrols = {
    v0: 1106,//左右
    upangle: 35,//上下
    x: 1,
    y:-1,
    z:-2,
    turnAngle:35,
    S:0.1
}
var gui = new dat.GUI({load: loadALVIN(), preset: 'fastball'});
gui.remember (gcontrols);
gui.add(gcontrols, 'v0', 0, 2500 );
gui.add(gcontrols, 'upangle',-2500, 1800);
gui.add(gcontrols, 'turnAngle',-1800, 1800);
gui.add(gcontrols, 'x', -3, 3);
gui.add(gcontrols, 'y', -3, 3);
gui.add(gcontrols, 'z', -3, 3);
gui.add(gcontrols, 'S', 0.001, 1.0);



$('#shoot').click(function() {
	turn = !turn;
  turn2 =true;
  if(turn) {
  	clock.start();
    $(this).text("reset");
  }
  else {
  	$(this).text("start");
  	clock = new THREE.Clock();
    clock2 = new THREE.Clock();
  }	  
  // add AxisHelper in init
  // 2D ball state variables: pos, vel, force
  v0=gcontrols.v0;
  upangle=gcontrols.upangle;
  x=gcontrols.x;
  y=gcontrols.y;
  z=gcontrols.z;
  turnAngle=gcontrols.turnAngle;
  omega0 = new THREE.Vector3(x,y,z).normalize();
  nowOmega = omega0.clone();
  pos = new THREE.Vector3 (0, 21, -184); 
  gravity = new THREE.Vector3(0, -98, 0);
  vel = new THREE.Vector3 (0,0,v0).applyAxisAngle (new THREE.Vector3(1,0,0), -Math.PI/upangle);
  vel = vel.applyAxisAngle (new THREE.Vector3(0,1,0), -Math.PI/turnAngle);
  
   // vr = 41.6
});

init();
animate();

var pose1 = {
	connectA : 1.0 , connectB : 0.5
};
var pose2 = {
	connectA : 0.5 , connectB : 0.5
};
var pose3 = {
	connectA : 0 , connectB : 0
};
var pose4= {
	connectA : -0.55 , connectB : -0.65
};
var pose5 = {
	connectA : -1.0 , connectB : -1.0
};
var pose6 = {
	connectA : -0.5 , connectB : 0
};


var keys = [{s: 0,pose: pose1}, 
						{s: 0.3,pose: pose2},
            {s: 0.4,pose: pose3},
            {s: 0.5,pose: pose4},
            {s: 0.6,pose: pose5},
            {s: 1,pose: pose6},
           ]; 

function init() {
	modeling();
  window.addEventListener('resize', onWindowResize, false);
  document.body.appendChild(renderer.domElement);
}

function modeling(){
	  THREE.ImageUtils.crossOrigin = '';

  //主頁面
  scene = new THREE.Scene();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0xBBFFFF);
  renderer.autoClear = false;
  document.body.appendChild(renderer.domElement);
  //主視角
  
  camera = new THREE.PerspectiveCamera(4, window.innerWidth / window.innerHeight, 1, 10000);
  camera.position.set(-40,75, -750);


  controls = new THREE.OrbitControls(camera, renderer.domElement);

  //光線
	light = new THREE.PointLight(0xffffff);
  light.position.set(0, 500, -500);
  scene.add(light);
  
  light = new THREE.PointLight(0xffffff);
  light.position.set(0, 500, 500);
  scene.add(light);
  
   camera2 = new THREE.PerspectiveCamera(8, window.innerWidth / window.innerHeight, 1, 10000);
  camera2.position.set(0, 6 , 90);
  
  cameraHUD = new THREE.OrthographicCamera(-10, 10, 10, -10, -10, 100000);
  cameraHUD.position.z = 300;
  
  sceneHUD = new THREE.Scene();
 	var fframe = new THREE.Mesh(new THREE.PlaneGeometry(22, 0.5), new THREE.MeshBasicMaterial({
    color: 0xffff34,
    depthTest: false
  }));
  var fup = fframe.clone();
  fup.position.set (0,10,0);
  var fdown = fframe.clone();
  fdown.position.set (0,-10,0);
	sceneHUD.add(fup);
  sceneHUD.add(fdown);
    
  sceneHUD2 = new THREE.Scene();
  var fframe1 = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 20), new THREE.MeshBasicMaterial({
    color: 0xffff34,
    depthTest: false
  }));
  var fright = fframe1.clone();
  fright.position.set (-10,0,0);
  var fleft = fframe1.clone();
  fleft.position.set (10,0,0);
	sceneHUD2.add(fright);
  sceneHUD2.add(fleft);
  /*
  light4 = new THREE.PointLight(0xffffff);
  light4.position.set(-300, 300, -500);
  scene.add(light4);
  
  light5 = new THREE.PointLight(0xffffff);
  light5.position.set(0, 300, 0);
  scene.add(light5);
*/
  /////////////////////////////////////////////////////////////////////////  

  //  1 單位 = 10公分 = 0.1公尺
  //	1公尺 = 10單位

  //球
  baseball = new THREE.Mesh(new THREE.SphereGeometry(1.2, 32, 32), new THREE.MeshLambertMaterial({
    side: THREE.DoubleSide,
    map: THREE.ImageUtils.loadTexture('https://i.imgur.com/ddu5eh4.jpg')
  }));
  var baseballPos = baseball.localToWorld(new THREE.Vector3(0, 0, 0))
  baseball.position.copy(baseballPos);

  //球速度方向標示
  velocityGeometry = new THREE.CylinderGeometry(0.3, 0.3, 5, 32);
  velocityMaterial = new THREE.MeshLambertMaterial({
    color: 0xff0000
  });
  velocity = new THREE.Mesh(velocityGeometry, velocityMaterial);
  velocity.position.set(0, 2.5, 0);
  velArrow = new THREE.Object3D();
  velArrow.add(velocity);
  velArrow.position.set(0,500,0);
  scene.add(velArrow);

  //求選轉方向標示
  omegaGeometry = new THREE.CylinderGeometry(0.3, 0.3, 5, 32);
  omegaMaterial = new THREE.MeshLambertMaterial({
    color: 0xffff00
  });
  omega = new THREE.Mesh(omegaGeometry, omegaMaterial);
  omega.position.set(0, 2.5, 0);
  omegaArrow = new THREE.Object3D();
  omegaArrow.add(omega);
  omegaArrow.position.set(0,500,0);
  scene.add(omegaArrow);

  scene.add(baseball);

	//全場
  grass = new THREE.Mesh(new THREE.PlaneGeometry(1200,1200), new THREE.MeshBasicMaterial({
  	side: THREE.DoubleSide,
    map: THREE.ImageUtils.loadTexture('https://i.imgur.com/lM5NGmP.jpg')
  }));
  grass.rotation.x = Math.PI/2;
  grass.rotation.z = Math.PI/4;
  grass.position.set(0,-0.5,-500);
  scene.add(grass);
  

  //內野
  infield = new THREE.Mesh(new THREE.BoxGeometry(274.3, 0.1, 274.3), new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('https://i.imgur.com/VRj6Sbl.jpg')
  }));
  infield.position.set(0, -193.9, 0);
  //投手丘
  geometrymount = new THREE.CylinderGeometry(1, 18.3, 4, 24);
  materialmount = new THREE.MeshLambertMaterial({
    color: 0x796400,
    side: THREE.DoubleSide,
    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg')
  });
  mount = new THREE.Mesh(geometrymount, materialmount);
  mount.position.set(0, 1.5, -184);
  geometrymount2 = new THREE.CylinderGeometry(18.3, 18.3, 1, 32);
  materialmount2 = new THREE.MeshLambertMaterial({
    color: 0x796400,
    side: THREE.DoubleSide,
    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg
  });
  mount2 = new THREE.Mesh(geometrymount2, materialmount2);
  mount2.position.set(0, 0, -184);
  scene.add(mount);
  //scene.add(mount2);


  geometry = new THREE.BoxGeometry(3.8, 1, 3.8);
  material = new THREE.MeshLambertMaterial({
    color: 0xffffff,
    side: THREE.DoubleSide});



  //一壘
  base1 = new THREE.Mesh(geometry, material);
  base1.position.set(135.3, 0, -137.4);
  infield.add(base1);
  geometrycircle = new THREE.CircleGeometry(30, 32);
  materialcircle = new THREE.MeshLambertMaterial({
    color: 0x796400,
    side: THREE.DoubleSide,
    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg')
  });
  base1floor = new THREE.Mesh(geometrycircle, materialcircle);
  base1floor.rotation.x = Math.PI / 2;
  base1floor.position.set(135.3, 0.2, -137.4);
  infield.add(base1floor);
  

  //二壘
  base2 = new THREE.Mesh(geometry, material);
  base2.position.set(-137.4, 0, -137.4);
  infield.add(base2);
  base2floor = new THREE.Mesh(geometrycircle, materialcircle);
  base2floor.rotation.x = Math.PI / 2;
  base2floor.position.set(-137.4, 0.2, -137.4);
  infield.add(base2floor);

  //三壘
  base3 = new THREE.Mesh(geometry, material);
  base3.position.set(-137.4, 0, 137.3);
  infield.add(base3);
  base3floor = new THREE.Mesh(geometrycircle, materialcircle);
  base3floor.rotation.x = Math.PI / 2;
  base3floor.position.set(-137.4, 0.2, 137.4);
  infield.add(base3floor);
  

  //本壘
  homebase = new THREE.Object3D();
  homebaseA = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 3), material);
  homebaseA.rotation.y = Math.PI / 4;
  homebaseB = new THREE.Mesh(new THREE.BoxGeometry(4.3, 1, 2.1), material);
  homebase.add(homebaseA);
  homebase.add(homebaseB);
  homebaseA.position.set(0, 0, 1.05);
  homebaseB.position.set(0, 0, 0);
  homebase.position.set(135, 0, 135);
  homebase.rotation.y = Math.PI / 4;
  infield.add(homebase);
	
  
  
  //本壘打擊區
 	geometrycircle = new THREE.CircleGeometry(60, 32);
  home = new THREE.Mesh(geometrycircle, materialcircle);
  home.rotation.x = Math.PI / 2;
  home.position.set(135, 0.2, 135);
  infield.add(home);
  geometrycircle = new THREE.CircleGeometry(61, 32, -Math.PI / 2 + 0.05, 4.6);
  materialcircle = new THREE.MeshLambertMaterial({
    color: 0xffffff,
    side: THREE.DoubleSide
  });
  home2 = new THREE.Mesh(geometrycircle, materialcircle);
  home2.rotation.x = Math.PI / 2;
  home2.position.set(135, 0.1, 135);
  infield.add(home2);
	
  //好球帶
  curve0 = new THREE.SplineCurve3([
    new THREE.Vector3(-2.5, 0, 0),
    new THREE.Vector3(2.5, 0, 0),
    new THREE.Vector3(2.5, 7, 0),
    new THREE.Vector3(-2.5, 7, 0),
    new THREE.Vector3(-2.5, 0, 0)
  ]);
  geometrystrikerange = new THREE.Geometry();
  geometrystrikerange.vertices = curve0.getPoints(4);
  materialstrikerange = new THREE.LineBasicMaterial({
    color: 0xff0000
  });
  strikeranger = new THREE.Line(geometrystrikerange, materialstrikerange);
  strikeranger.position.set(0, 4, 0);
  scene.add(strikeranger);
	
  //左打擊格
  curve = new THREE.SplineCurve3([
    new THREE.Vector3(0, 0.5, -6),
    new THREE.Vector3(0, 0.5, 12),
    new THREE.Vector3(9, 0.5, 12),
    new THREE.Vector3(9, 0.5, -6),
    new THREE.Vector3(0, 0.5, -6)
  ]);
  geometrycurve = new THREE.Geometry();
  geometrycurve.vertices = curve.getPoints(4);
  materialcurve = new THREE.LineBasicMaterial({
    color: 0xffffff
  });
  splineObject0 = new THREE.Line(geometrycurve, materialcurve);
  splineObject0.position.set(3, 0, -5);
  scene.add(splineObject0);
  //右打擊格

  splineObject1 = new THREE.Line(geometrycurve, materialcurve);
  splineObject1.position.set(-12, 0, -5);
  scene.add(splineObject1);

 	//一壘準備區
  
  base1preparation = new THREE.Mesh( new THREE.PlaneGeometry(200,1020),  new THREE.MeshLambertMaterial( {color: 0x796400,
    side: THREE.DoubleSide,    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg
  base1preparation.position.set(240, 0.05, -265);
  base1preparation.rotation.x = -Math.PI/2;
  infield.add(base1preparation);
  
  base3preparation = new THREE.Mesh( new THREE.PlaneGeometry(200,1020),  new THREE.MeshLambertMaterial( {color: 0x796400,
    side: THREE.DoubleSide,    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg')}));
  base3preparation.position.set( -265, 0.04, 240);
  base3preparation.rotation.x = Math.PI/2;
  base3preparation.rotation.z = Math.PI/2;
  
  infield.add(base3preparation);


  //壘包線本壘至一壘
  geometryline = new THREE.BoxGeometry(900, 0.5, 1);
  material = new THREE.MeshBasicMaterial( { color: 0xffffff,side:THREE.DoubleSide } );
  baseline1 = new THREE.Mesh(geometryline, material);
  baseline1.rotation.y = Math.PI / 2;
  baseline1.position.set(137.3, 0, -330);
  infield.add(baseline1);
	//跑道
  runwaygeometry = new THREE.BoxGeometry(900, 0.15, 20 );
  runwaymaterial = new THREE.MeshLambertMaterial( {color: 0x796400,
    side: THREE.DoubleSide,
    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg') } );
  runway1 = new THREE.Mesh(runwaygeometry, runwaymaterial);
  runway1.rotation.y = Math.PI / 2;
  runway1.position.set(137.3, 0, -315);
  infield.add(runway1);  

  //壘包線本壘至三壘
  baseline2 = new THREE.Mesh(geometryline, material);
  baseline2.position.set(-330, 0, 137.3);
  infield.add(baseline2);
  //跑道
  runway2 = new THREE.Mesh(runwaygeometry, runwaymaterial);
  //runway2.rotation.y = Math.PI / 2;
  runway2.position.set(-315, 0, 137.3);
  infield.add(runway2);
  
  //外野
  
  geometry = new THREE.CircleGeometry( 900, 64, Math.PI ,Math.PI/2 );
  outfield  = new THREE.Mesh( geometry, new THREE.MeshBasicMaterial({
    map: THREE.ImageUtils.loadTexture('https://i.imgur.com/sht0P3U.jpg'),
    side: THREE.DoubleSide
  }) );
  outfield.rotation.z = Math.PI/4;
  outfield.rotation.x = Math.PI/2; 
  outfield.position.set( 0, -0.2, 50);
  scene.add( outfield );
  
  //全壘打牆
  outfieldwall = new THREE.Mesh( new THREE.CylinderGeometry( 900, 900, 30, 64, 9, true, Math.PI/1.4725 ,Math.PI/1.558 ), new THREE.MeshBasicMaterial({
  color: 0x999999,
    side: THREE.DoubleSide,
    //map: THREE.ImageUtils.loadTexture('https://i.imgur.com/wYfhasR.jpg')
  }) );
  outfieldwall.position.set( 0, 15, 0);
  scene.add( outfieldwall );
 
  //本壘後方
  homebasebackward =  new THREE.Mesh( new THREE.CylinderGeometry( 350, 350, 20, 64, 9, true, -0.55, Math.PI/2.85 ), new THREE.MeshBasicMaterial({
  	color: 0xCCCCCC,
    side: THREE.DoubleSide,
     map: THREE.ImageUtils.loadTexture('https://i.imgur.com/Ta41OXk.jpg')
  }) );
  homebasebackward.position.set( 0, 10, -200);
  scene.add(homebasebackward);
  
  homebasebackward2 =  new THREE.Mesh( new THREE.CylinderGeometry( 350, 350, 100, 64, 9, true, -0.55, Math.PI/2.85 ), new THREE.MeshBasicMaterial({
    transparent: true,
    side: THREE.DoubleSide,
     map: THREE.ImageUtils.loadTexture('https://i.imgur.com/fihD9tq.png')
  }) );
  homebasebackward2.position.set( 0, 70, -200);
  scene.add(homebasebackward2);
  
  //柱子
  pillar =  new THREE.Mesh( new THREE.CylinderGeometry(5, 5, 130, 64), new THREE.MeshBasicMaterial({
   color:0x000000
  }));
  
  pillar.position.set(185, 65, 95);
  scene.add(pillar);
  
  pillar2 = pillar.clone();
  pillar2.position.set(-185, 65, 95);
  scene.add(pillar2);
  
  pillar3 = pillar.clone();
  pillar3.position.set(760, 65, -480);
  scene.add(pillar3);
  
  pillar4 = pillar.clone();
  pillar4.position.set(-760, 65, -480);
  scene.add(pillar4);
  
  //一壘牆
  base1wall = new THREE.Mesh( new THREE.PlaneGeometry(820,20 ), new THREE.MeshBasicMaterial({
  color: 0xCCCCCC,
    side: THREE.DoubleSide
  }));
  base1wall.rotation.y = Math.PI/2;
  base1wall.position.set(335, 10, -330);
  infield.add(base1wall);
  
  base1wall2 = new THREE.Mesh( new THREE.PlaneGeometry(810,100 ), new THREE.MeshBasicMaterial({
   transparent: true,
    side: THREE.DoubleSide,
    map: THREE.ImageUtils.loadTexture('https://i.imgur.com/fihD9tq.png')
  }));
  base1wall2.rotation.y = Math.PI/2;
  base1wall2.position.set(335, 70, -330);
  infield.add(base1wall2);
  
  
  //三壘牆
  base3wall = new THREE.Mesh( new THREE.PlaneGeometry(820,20 ),new THREE.MeshBasicMaterial({ 
  color: 0xCCCCCC,
    side: THREE.DoubleSide
  })); 
  base3wall.position.set( -330, 10, 335);
  infield.add(base3wall);
  
   base3wall2 = new THREE.Mesh( new THREE.PlaneGeometry(810,100 ), new THREE.MeshBasicMaterial({
 transparent: true,
    side: THREE.DoubleSide,
    map: THREE.ImageUtils.loadTexture('https://i.imgur.com/fihD9tq.png')
  }));
  base3wall2.position.set( -330, 70, 335);
  infield.add(base3wall2);
  	
  
  
  //野區
  geometry = new THREE.CircleGeometry( 480, 64, Math.PI ,Math.PI/2 );
  diamond = new THREE.Mesh( geometry, new THREE.MeshLambertMaterial({
    color: 0x796400,
    side: THREE.DoubleSide,
    map:THREE.ImageUtils.loadTexture('https://i.imgur.com/guh5eKy.jpg')
  }) );
  diamond.rotation.z = Math.PI/4;
  diamond.rotation.x = Math.PI/2; 
  diamond.position.set( 0, -0.1, 50);
  scene.add( diamond );
  

  ///投球機
  pitchmachine = new THREE.Object3D();
  pitchpedestal = new THREE.Mesh(new THREE.BoxGeometry(5, 8, 5), new THREE.MeshLambertMaterial({
    color: 0x00ffff,
    side: THREE.DoubleSide
  }));
  pitchpedestal.position.set(0, 4, 0);
  pitchmachine.add(pitchpedestal);


  connectA = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), new THREE.MeshLambertMaterial({
    color: 0xff00ff,
    side: THREE.DoubleSide
  }));
  connectA.position.set(0, 4.75, 0);
  pitchpedestal.add(connectA);

  pitcharmA = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 5, 64, 64), new THREE.MeshLambertMaterial({
    color: 0xffff00,
    side: THREE.DoubleSide
  }));
  pitcharmA.position.set(0, 3.25, 0);
  connectA.add(pitcharmA);

  endEffector = new THREE.Object3D();
  endEffector.position.set(0, 3.25, 0);
  pitcharmA.add(endEffector);

  connectB = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), new THREE.MeshLambertMaterial({
    color: 0xff00ff,
    side: THREE.DoubleSide
  }));
  endEffector.add(connectB);


  pitcharmB = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 5, 64, 64), new THREE.MeshLambertMaterial({
    color: 0xffff00,
    side: THREE.DoubleSide
  }));
  pitcharmB.position.set(0, 3.25, 0);
  connectB.add(pitcharmB);

  //
  pitchmachine.position.set(8, 0, 8);
  pitchmachine.rotation.y = -Math.PI / 4;
  infield.add(pitchmachine);
  infield.position.set(0, 0, -193.9);
  infield.rotation.y = -Math.PI / 4;

  scene.add(infield);
}



function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function orientOmegaArrow() {
	var yellowVector = new THREE.Vector3( 0, 1, 0 );
  //console.log(newOmega);
  var angle = yellowVector.angleTo (nowOmega);
  if (angle!=0){
    var axis = new THREE.Vector3();
    axis.crossVectors ( yellowVector, nowOmega ).normalize();
    omegaArrow.rotation.set (0,0,0);
    omegaArrow.rotateOnAxis ( axis, angle );
  }
}

function animate() {
  
  controls.update();
  var baseballposi  =baseball.localToWorld(new THREE.Vector3(0, 0, 0))
  
 	if(turn) {
  	flightOfBall();
  }
  else {
  	baseball.position.set(0,21,-183);
    connectA.rotation.z = 0;
    endEffector.rotation.z =0;
  }
  keyboard.update();
  
  requestAnimationFrame(animate);
  render();
  renderer.render(scene, camera2);
  
}

function flightOfBall(){
	
  if(turn2){
  	
    var t = clock.getElapsedTime() % period;
    var s = t / period; // normalized time
		
    for (var i = keys.length - 1; i >= 0; i--) {
      if (s > keys[i].s)
        break;
    }
    // linearly interpolate between i & i+1
    var tt = (s - keys[i].s) / (keys[i + 1].s - keys[i].s);
    
    var connectAA = (1 - tt) * keys[i].pose.connectA + tt * keys[i + 1].pose.connectA;
    var connectBB = (1 - tt) * keys[i].pose.connectB + tt * keys[i + 1].pose.connectB;
    
  	
    connectA.rotation.z = connectAA;
    
   
	}
  
  if(s > 0.4&&s < 0.6){     		
        if(turn2 === true){
        	dt = (clock.oldTime - clock.startTime)/ 1000; 
  		
        }  
    }
  if(s>0.97){    
  	  turn2 =false;
      
  }
    
   if(connectBB > 0){
     var eepos = endEffector.children[0].localToWorld(new THREE.Vector3(0, 6, 0));
     baseball.position.copy(eepos); 
   }   
  else{
    	var dtt = clock2.getDelta();
 			update(dtt);     	
    }
  camera.lookAt(baseball.position);
  

}

function loadALVIN() {
	return {  // must be return {    return \n { will become a new line
    "preset": "fastball",
    "closed": false,
    "remembered": {
      "fastball": {
        "0": {
          "v0": 1840,//左右
          "upangle": 860,//上下
          "x":1,
          "y":0,
          "z":0,
          "turnAngle":1800,
          "S":0.0984
        }
      },
      "changeup": {
        "0": {
          "v0": 862,//左右
          "upangle": 35,//上下
          "x":1,
          "y":0,
          "z":0,
          "turnAngle":1800,
          "S":0.0
          
        }
      },
      "leftslider": {
        "0": {
          "v0": 1447,//左右
          "upangle": 54,//上下
          "x":1,
          "y":-1,
          "z":-0,
          "turnAngle":-40,
          "S":0.1959
          
        }
      },
      "rightslider": {
        "0": {
          "v0": 1447,//左右
          "upangle": 54,//上下
          "x":1,
          "y":1,
          "z":0,
          "turnAngle":40,
          "S":0.1959
          
        }
      },
      "sinker": {
        "0": {
          "v0": 2500,//左右
          "upangle": 250,//上下
          "x":2,
          "y":0,
          "z":0,
          "turnAngle":1800,
          "S":0.31
          
        }
      }
    },
    "folders": {}
  } ;
}

function update (dt) {
	dt=dt/5;
  Cdv = 7;
  P = 1.2474/1000;
  A= 0.144;
  V= vel.length();
  FD = -1/2*Cdv*P*A*V*V;

	
	AirDrag = vel.clone().normalize().multiplyScalar (FD);
	
  
  var force =new THREE.Vector3(0,0,0);
  force.copy(gravity);
  S=gcontrols.S;
  FM =nowOmega.clone().cross(vel).multiplyScalar(S);
  force.add(FM);
  force.add(AirDrag);
  
  vel.add (force.clone().multiplyScalar (dt/0.144));
  pos.add (vel.clone().multiplyScalar(dt));
  if(pos.y<0){
  	return;
  }
  baseball.position.set (pos.x, pos.y, pos.z);
 
  velArrow.position.copy(baseball.position);
  redVector = new THREE.Vector3( 0, 1, 0 );
  angle = redVector.angleTo (vel);
  axis = new THREE.Vector3();
  
  axis.crossVectors ( redVector, vel ).normalize();
  velArrow.rotation.set (0,0,0);
  velArrow.rotateOnAxis ( axis, angle );
  
  /// omega
  if (typeof velold !== "undefined") {
  
    omegaArrow.position.copy(baseball.position);
    angle=vel.angleTo(velold);
    axis.crossVectors(velold,vel).normalize();
    nowOmega.applyAxisAngle (axis,angle);
    console.log(nowOmega);
    orientOmegaArrow();
  } 
  else {
  	velold = new THREE.Vector3();
  }

  velold.copy (vel);
	angle+=0.1;
  baseball.rotateOnAxis(axis,angle);
}

function render() {
  var WW = window.innerWidth;
  var HH = window.innerHeight;
	renderer.clear();
  renderer.setViewport(0, 0, WW , HH);
  renderer.render(scene, camera);
  renderer.setViewport(WW-WW/1.005, HH-HH/4, WW / 4, HH/4);
  renderer.render(sceneHUD, cameraHUD);
  renderer.render(sceneHUD2, cameraHUD);
  renderer.render(scene, camera2);

  
}

</script>
</body>

</html>
